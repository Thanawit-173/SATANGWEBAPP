<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Kinematics - การเคลื่อนที่แนวเส้นตรง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
        canvas { display: block; border-radius: 0.5rem; background-color: white; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .slider { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #e2e8f0; outline: none; opacity: 0.7; transition: opacity .2s; }
        .slider:hover { opacity: 1; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        .slider::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        .tab-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .hatch-pattern { background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(239, 68, 68, 0.2) 10px, rgba(239, 68, 68, 0.2) 20px); }
        
        /* Modal Styles */
        #compareModal { display: none; }
        #compareModal.flex { display: flex; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-md flex justify-between items-center z-10">
        <div>
            <h1 class="text-2xl font-bold"><i class="fa-solid fa-car-side mr-2"></i> 5 สมการการเคลื่อนที่แนวเส้นตรง</h1>
            <p class="text-blue-200 text-sm">เรียนรู้ผ่านการสังเกตการเคลื่อนที่และกราฟ</p>
        </div>
        <div class="flex gap-2">
            <button id="btnCompare" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded font-medium transition shadow">
                <i class="fa-solid fa-table-list mr-1"></i> เปรียบเทียบทุกสมการ
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left/Middle Column: Visuals -->
        <div class="flex-1 flex flex-col p-4 gap-4 overflow-y-auto bg-slate-100">
            
            <!-- Area 1: Animation -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-bold text-slate-700">1. การเคลื่อนที่จริง (Real Motion)</h2>
                    <div class="flex gap-2">
                        <span class="text-sm bg-slate-100 px-2 py-1 rounded text-slate-600" id="timeDisplay">t = 0.00 s</span>
                        <span class="text-sm bg-blue-100 px-2 py-1 rounded text-blue-700" id="velDisplay">v = 0.00 m/s</span>
                        <span class="text-sm bg-green-100 px-2 py-1 rounded text-green-700" id="distDisplay">s = 0.00 m</span>
                    </div>
                </div>
                <div class="relative w-full h-32 bg-slate-50 rounded-lg border border-slate-200 overflow-hidden" id="animContainer">
                    <!-- Road -->
                    <div class="absolute bottom-4 left-0 w-full h-2 bg-slate-300"></div>
                    <!-- Markers -->
                    <div class="absolute bottom-0 left-[5%] h-6 w-[2px] bg-slate-400"></div>
                    <div class="absolute bottom-0 left-[5%] text-xs text-slate-500 -ml-1 mt-6">0m</div>
                    <!-- Object -->
                    <div id="movingObject" class="absolute bottom-4 w-10 h-6 bg-blue-600 rounded-sm transform -translate-x-1/2 -translate-y-1 flex items-center justify-center text-white text-xs shadow-md" style="left: 5%;">
                        <i class="fa-solid fa-car"></i>
                    </div>
                    <!-- Velocity Vector -->
                    <div id="velVector" class="absolute bottom-7 h-1 bg-red-500 origin-left" style="left: 5%; width: 0px;">
                        <div class="absolute -right-1 -top-[3px] w-0 h-0 border-t-[4px] border-t-transparent border-b-[4px] border-b-transparent border-l-[6px] border-l-red-500"></div>
                    </div>
                </div>
                
                <!-- Play Controls -->
                <div class="flex justify-center gap-4 mt-4">
                    <button id="btnPlay" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg flex items-center justify-center transition transform hover:scale-105">
                        <i class="fa-solid fa-play text-xl ml-1"></i>
                    </button>
                    <button id="btnReset" class="w-12 h-12 bg-slate-500 hover:bg-slate-600 text-white rounded-full shadow-lg flex items-center justify-center transition transform hover:scale-105">
                        <i class="fa-solid fa-rotate-left text-xl"></i>
                    </button>
                    <button id="btnRandom" class="w-12 h-12 bg-purple-500 hover:bg-purple-600 text-white rounded-full shadow-lg flex items-center justify-center transition transform hover:scale-105" title="สุ่มสถานการณ์">
                        <i class="fa-solid fa-dice text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Area 2: Graphs -->
            <div class="flex-1 flex flex-col md:flex-row gap-4 min-h-[300px]">
                <!-- v-t Graph -->
                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                    <h2 class="text-lg font-bold text-slate-700 mb-2">2. กราฟ ความเร็ว-เวลา (v-t Graph)</h2>
                    <div class="flex-1 relative w-full h-full min-h-[200px]">
                        <canvas id="vtCanvas" class="absolute inset-0 w-full h-full"></canvas>
                    </div>
                    <p class="text-xs text-center text-slate-500 mt-2">* พื้นที่ใต้กราฟ = ระยะทาง (s), ความชัน = ความเร่ง (a)</p>
                </div>
                <!-- s-t Graph -->
                <div class="flex-1 bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                    <h2 class="text-lg font-bold text-slate-700 mb-2">กราฟ ระยะทาง-เวลา (s-t Graph)</h2>
                    <div class="flex-1 relative w-full h-full min-h-[200px]">
                        <canvas id="stCanvas" class="absolute inset-0 w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Controls & Equations -->
        <div class="w-full md:w-96 bg-white border-l border-slate-200 shadow-xl flex flex-col z-20">
            
            <!-- Mode Selector -->
            <div class="p-4 border-b border-slate-100 bg-slate-50">
                <h3 class="font-bold text-slate-700 mb-3 text-sm uppercase tracking-wider">โหมดอธิบายสมการ</h3>
                <div class="grid grid-cols-2 gap-2" id="modeSelector">
                    <button class="tab-btn active border rounded py-2 text-sm font-medium transition" data-mode="0">ทั่วไป (General)</button>
                    <button class="tab-btn border rounded py-2 text-sm font-medium transition" data-mode="1">v = u + at</button>
                    <button class="tab-btn border rounded py-2 text-sm font-medium transition" data-mode="2">s = ut + ½at²</button>
                    <button class="tab-btn border rounded py-2 text-sm font-medium transition" data-mode="3">v² = u² + 2as</button>
                    <button class="tab-btn border rounded py-2 text-sm font-medium transition" data-mode="4">s = ½(u+v)t</button>
                    <button class="tab-btn border rounded py-2 text-sm font-medium transition" data-mode="5">s = vt - ½at²</button>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="p-6 border-b border-slate-100">
                <h3 class="font-bold text-slate-700 mb-4 text-lg">3. แผงควบคุม (Controls)</h3>
                
                <!-- Standard Controls (hidden in mode 3) -->
                <div id="standardControls" class="space-y-5">
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-medium text-slate-600">ความเร็วต้น u (m/s)</label>
                            <span id="uValDisplay" class="font-bold text-blue-600">10</span>
                        </div>
                        <input type="range" id="uSlider" min="0" max="40" step="1" value="10" class="slider">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-medium text-slate-600">ความเร่ง a (m/s²)</label>
                            <span id="aValDisplay" class="font-bold text-red-500">2</span>
                        </div>
                        <input type="range" id="aSlider" min="-5" max="10" step="0.5" value="2" class="slider">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-medium text-slate-600">เวลาสิ้นสุด t (s)</label>
                            <span id="tValDisplay" class="font-bold text-green-600">5</span>
                        </div>
                        <input type="range" id="tSlider" min="1" max="10" step="0.5" value="5" class="slider">
                    </div>
                </div>

                <!-- Mode 3 Controls -->
                <div id="mode3Controls" class="space-y-5 hidden">
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-2">
                        <p class="text-sm text-blue-800 font-medium"><i class="fa-solid fa-circle-info mr-1"></i> โหมดนี้เชื่อมความเร็วกับระยะทางโดยไม่สนเวลา ลองทายความเร็วปลายดูสิ!</p>
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-medium text-slate-600">ความเร็วต้น u (m/s)</label>
                            <span id="m3_uValDisplay" class="font-bold text-blue-600">10</span>
                        </div>
                        <input type="range" id="m3_uSlider" min="0" max="40" step="1" value="10" class="slider">
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-medium text-slate-600">ความเร่ง a (m/s²)</label>
                            <span id="m3_aValDisplay" class="font-bold text-red-500">2</span>
                        </div>
                        <input type="range" id="m3_aSlider" min="0" max="10" step="0.5" value="2" class="slider"> <!-- Keep positive for simplicity in mode 3 -->
                    </div>
                    <div>
                        <div class="flex justify-between mb-1">
                            <label class="text-sm font-medium text-slate-600">ระยะทางเป้าหมาย s (m)</label>
                            <span id="m3_sValDisplay" class="font-bold text-green-600">100</span>
                        </div>
                        <input type="range" id="m3_sSlider" min="10" max="500" step="10" value="100" class="slider">
                    </div>
                    <div class="mt-4 border-t pt-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">ทายความเร็วปลาย v (m/s):</label>
                        <div class="flex gap-2">
                            <input type="number" id="vGuessInput" class="border rounded px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ระบุตัวเลข...">
                        </div>
                        <div id="m3Result" class="mt-2 text-sm font-bold hidden"></div>
                    </div>
                </div>
                
                <!-- Real-time Status Calculation -->
                <div class="mt-6 bg-slate-100 p-3 rounded text-sm text-slate-700">
                    <div class="flex justify-between border-b border-slate-200 pb-1 mb-1">
                        <span>ความเร็วปลายจริง (v):</span>
                        <span id="calcV" class="font-bold text-blue-700">-- m/s</span>
                    </div>
                    <div class="flex justify-between">
                        <span>ระยะทางจริง (s):</span>
                        <span id="calcS" class="font-bold text-green-700">-- m</span>
                    </div>
                </div>
            </div>

            <!-- Explanation Panel -->
            <div class="p-6 flex-1 overflow-y-auto bg-blue-50/50">
                <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-book-open text-blue-600"></i> คำอธิบาย (Explanation)
                </h3>
                <div id="explanationText" class="text-slate-600 text-sm leading-relaxed space-y-3">
                    <p>เริ่มต้นจากการปรับค่า <b>u</b>, <b>a</b>, <b>t</b> แล้วกด <b>Play</b> เพื่อดูการเคลื่อนที่จริง</p>
                    <p>จากนั้นเลือก <b>"โหมดอธิบายสมการ"</b> ด้านบน เพื่อดูว่ากราฟและการเคลื่อนที่เชื่อมโยงกับสมการแต่ละสูตรอย่างไร</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Compare Modal -->
    <div id="compareModal" class="fixed inset-0 bg-black/60 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-blue-900 text-white p-4 flex justify-between items-center">
                <h2 class="text-xl font-bold">ตารางพิสูจน์: ทุกสมการให้ผลลัพธ์เดียวกัน</h2>
                <button id="btnCloseModal" class="text-white hover:text-red-300 transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <p class="mb-4 text-slate-600">เมื่อใช้ค่าปัจจุบัน <b>u = <span id="cmpU"></span> m/s</b>, <b>a = <span id="cmpA"></span> m/s²</b>, และ <b>t = <span id="cmpT"></span> s</b></p>
                
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-100 border-b-2 border-slate-300">
                            <th class="p-3 text-slate-700">สมการ</th>
                            <th class="p-3 text-slate-700">การแทนค่า</th>
                            <th class="p-3 text-slate-700 text-right">ผลลัพธ์</th>
                        </tr>
                    </thead>
                    <tbody id="compareTableBody" class="divide-y divide-slate-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
                <div class="mt-6 bg-green-50 text-green-800 p-4 rounded-lg border border-green-200">
                    <p class="font-bold"><i class="fa-solid fa-check-circle mr-2"></i> สรุป</p>
                    <p class="text-sm mt-1">จะเห็นได้ว่าไม่ว่าจะเลือกใช้สมการใด หากใช้ตัวแปรชุดเดียวกันจากการเคลื่อนที่จริง จะได้คำตอบของความเร็วปลาย (v) และระยะทาง (s) <b>ตรงกันเสมอ</b> สมการเหล่านี้เป็นเพียงมุมมองทางคณิตศาสตร์ที่แตกต่างกันของเหตุการณ์เดียวกัน</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const state = {
            mode: 0, // 0: general, 1: eq1, 2: eq2, 3: eq3, 4: eq4, 5: eq5
            u: 10,
            a: 2,
            t: 5,   // Total time target
            s: 0,   // Calculated total distance
            v: 0,   // Calculated final velocity
            
            // Mode 3 specific
            m3_u: 10,
            m3_a: 2,
            m3_sTarget: 100,
            m3_vGuess: null,
            
            // Animation state
            t_curr: 0,
            isPlaying: false,
            animReq: null,
            lastFrameTime: 0
        };

        // --- DOM Elements ---
        // Sliders & Displays (Standard)
        const uSlider = document.getElementById('uSlider');
        const aSlider = document.getElementById('aSlider');
        const tSlider = document.getElementById('tSlider');
        const uDisp = document.getElementById('uValDisplay');
        const aDisp = document.getElementById('aValDisplay');
        const tDisp = document.getElementById('tValDisplay');
        
        // Sliders & Displays (Mode 3)
        const m3_uSlider = document.getElementById('m3_uSlider');
        const m3_aSlider = document.getElementById('m3_aSlider');
        const m3_sSlider = document.getElementById('m3_sSlider');
        const m3_uDisp = document.getElementById('m3_uValDisplay');
        const m3_aDisp = document.getElementById('m3_aValDisplay');
        const m3_sDisp = document.getElementById('m3_sValDisplay');
        const vGuessInput = document.getElementById('vGuessInput');
        const m3Result = document.getElementById('m3Result');

        // Panels
        const stdControls = document.getElementById('standardControls');
        const m3Controls = document.getElementById('mode3Controls');
        const explText = document.getElementById('explanationText');

        // Animation UI
        const timeDisplay = document.getElementById('timeDisplay');
        const velDisplay = document.getElementById('velDisplay');
        const distDisplay = document.getElementById('distDisplay');
        const calcV = document.getElementById('calcV');
        const calcS = document.getElementById('calcS');
        const btnPlay = document.getElementById('btnPlay');
        const btnReset = document.getElementById('btnReset');
        const btnRandom = document.getElementById('btnRandom');
        const objectDiv = document.getElementById('movingObject');
        const velVector = document.getElementById('velVector');
        const animContainer = document.getElementById('animContainer');

        // Canvases
        const vtCanvas = document.getElementById('vtCanvas');
        const vtCtx = vtCanvas.getContext('2d');
        const stCanvas = document.getElementById('stCanvas');
        const stCtx = stCanvas.getContext('2d');

        // Modal
        const compareModal = document.getElementById('compareModal');
        const btnCompare = document.getElementById('btnCompare');
        const btnCloseModal = document.getElementById('btnCloseModal');
        const compareTableBody = document.getElementById('compareTableBody');

        // --- Physics Calculations ---
        function calculatePhysics() {
            if (state.mode === 3) {
                // In Mode 3, u, a, s are inputs. Calculate expected v. (t is implicit)
                state.v = Math.sqrt(state.m3_u * state.m3_u + 2 * state.m3_a * state.m3_sTarget);
                if(isNaN(state.v)) state.v = 0; // Prevent NaN if negative under root
                state.t = (state.v - state.m3_u) / state.m3_a;
                if(state.m3_a === 0) state.t = state.m3_sTarget / state.m3_u;
                state.s = state.m3_sTarget;
                
                // Update specific UI
                calcV.textContent = "?? m/s (โหมดทายผล)";
                calcS.textContent = state.s.toFixed(2) + " m";
            } else {
                // Normal Mode: u, a, t are inputs.
                state.v = state.u + state.a * state.t;
                state.s = (state.u * state.t) + (0.5 * state.a * state.t * state.t);
                
                // Update UI
                calcV.textContent = state.v.toFixed(2) + " m/s";
                calcS.textContent = state.s.toFixed(2) + " m";
            }
        }

        // --- Event Listeners Setup ---
        function setupListeners() {
            // Standard Sliders
            uSlider.addEventListener('input', (e) => { state.u = parseFloat(e.target.value); uDisp.textContent = state.u; resetAnimation(); updateAll(); });
            aSlider.addEventListener('input', (e) => { state.a = parseFloat(e.target.value); aDisp.textContent = state.a; resetAnimation(); updateAll(); });
            tSlider.addEventListener('input', (e) => { state.t = parseFloat(e.target.value); tDisp.textContent = state.t; resetAnimation(); updateAll(); });

            // Mode 3 Sliders
            m3_uSlider.addEventListener('input', (e) => { state.m3_u = parseFloat(e.target.value); m3_uDisp.textContent = state.m3_u; resetAnimation(); updateAll(); });
            m3_aSlider.addEventListener('input', (e) => { state.m3_a = parseFloat(e.target.value); m3_aDisp.textContent = state.m3_a; resetAnimation(); updateAll(); });
            m3_sSlider.addEventListener('input', (e) => { state.m3_sTarget = parseFloat(e.target.value); m3_sDisp.textContent = state.m3_sTarget; resetAnimation(); updateAll(); });

            // Buttons
            btnPlay.addEventListener('click', togglePlay);
            btnReset.addEventListener('click', () => { resetAnimation(); updateAll(); });
            btnRandom.addEventListener('click', randomizeInputs);
            
            // Mode Selection
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    setMode(parseInt(e.target.dataset.mode));
                });
            });

            // Modal
            btnCompare.addEventListener('click', openCompareModal);
            btnCloseModal.addEventListener('click', () => compareModal.classList.remove('flex'));
            
            // Resize handler for canvas
            window.addEventListener('resize', resizeCanvases);
        }

        function setMode(modeNum) {
            state.mode = modeNum;
            resetAnimation();
            
            // Toggle Control Panels
            if (modeNum === 3) {
                stdControls.classList.add('hidden');
                m3Controls.classList.remove('hidden');
                // Sync initial values
                state.m3_u = state.u; m3_uSlider.value = state.u; m3_uDisp.textContent = state.u;
                state.m3_a = Math.max(0, state.a); m3_aSlider.value = state.m3_a; m3_aDisp.textContent = state.m3_a; // Ensure positive 'a' for simplicity
                vGuessInput.value = "";
                m3Result.classList.add('hidden');
            } else {
                stdControls.classList.remove('hidden');
                m3Controls.classList.add('hidden');
            }

            updateExplanation();
            updateAll();
        }

        function randomizeInputs() {
            if(state.mode === 3) {
                m3_uSlider.value = state.m3_u = Math.floor(Math.random() * 20) + 5;
                m3_aSlider.value = state.m3_a = Math.floor(Math.random() * 5) + 1;
                m3_sSlider.value = state.m3_sTarget = Math.floor(Math.random() * 200) + 50;
                m3_uDisp.textContent = state.m3_u; m3_aDisp.textContent = state.m3_a; m3_sDisp.textContent = state.m3_sTarget;
                vGuessInput.value = "";
                m3Result.classList.add('hidden');
            } else {
                uSlider.value = state.u = Math.floor(Math.random() * 20);
                aSlider.value = state.a = Math.floor(Math.random() * 8) - 2;
                tSlider.value = state.t = Math.floor(Math.random() * 6) + 2;
                uDisp.textContent = state.u; aDisp.textContent = state.a; tDisp.textContent = state.t;
            }
            resetAnimation();
            updateAll();
        }

        // --- Explanation Texts ---
        function updateExplanation() {
            let html = "";
            switch(state.mode) {
                case 0:
                    html = `
                        <p class="font-bold text-slate-800 text-base">โหมดสังเกตการณ์ทั่วไป</p>
                        <ul class="list-disc pl-5 space-y-2 mt-2">
                            <li>สังเกตการเคลื่อนที่ของรถด้านซ้าย</li>
                            <li>ดูกราฟ v-t (ตรงกลาง) แกน x คือเวลา แกน y คือความเร็ว ความชันของเส้นบอก <b>ความเร่ง (a)</b> และพื้นที่ใต้กราฟบอก <b>ระยะทาง (s)</b></li>
                            <li>ดูกราฟ s-t (ขวา) จะเห็นลักษณะเป็นเส้นโค้งเมื่อมีความเร่ง</li>
                        </ul>
                    `;
                    break;
                case 1:
                    html = `
                        <div class="text-center mb-3"><span class="bg-blue-100 text-blue-800 font-bold text-lg px-3 py-1 rounded">v = u + at</span></div>
                        <p>สมการนี้อธิบาย <b>ความเร็วปลาย (v)</b></p>
                        <ul class="list-disc pl-5 space-y-2 mt-2">
                            <li><span class="text-blue-600 font-bold">u</span> คือ ความเร็วตั้งต้น (จุดตัดแกน y บนกราฟ)</li>
                            <li><span class="text-purple-600 font-bold">at</span> คือ ความเร็วที่เปลี่ยนไป เกิดจาก ความเร่ง (a) คูณ เวลา (t) ซึ่งก็คือส่วนสูงที่เพิ่มขึ้นในกราฟ</li>
                            <li>รวมกันแล้วจึงได้ความเร็วสุดท้าย <b>v</b> ที่จุดปลาย</li>
                        </ul>
                    `;
                    break;
                case 2:
                    html = `
                        <div class="text-center mb-3"><span class="bg-blue-100 text-blue-800 font-bold text-lg px-3 py-1 rounded">s = ut + ½at²</span></div>
                        <p>สมการนี้คำนวณ <b>ระยะทาง (s)</b> จากการแบ่งพื้นที่ใต้กราฟ v-t เป็น 2 ส่วน:</p>
                        <ul class="list-disc pl-5 space-y-2 mt-2">
                            <li><span class="text-blue-600 font-bold">พื้นที่สี่เหลี่ยม (ut)</span>: ระยะทางที่ได้หากรถวิ่งด้วยความเร็วคงที่ u ตลอดเวลา</li>
                            <li><span class="text-green-600 font-bold">พื้นที่สามเหลี่ยม (½at²)</span>: ระยะทางพิเศษที่ได้เพิ่มมาจากการมีความเร่ง (a) ทำให้ความเร็วเพิ่มขึ้น</li>
                            <li>นำสองพื้นที่มารวมกันจะได้ระยะทางทั้งหมด</li>
                        </ul>
                    `;
                    break;
                case 3:
                    html = `
                        <div class="text-center mb-3"><span class="bg-blue-100 text-blue-800 font-bold text-lg px-3 py-1 rounded">v² = u² + 2as</span></div>
                        <p>สมการนี้พิเศษตรงที่ <b>ไม่มีตัวแปรเวลา (t)</b> เข้ามาเกี่ยวข้องเลย</p>
                        <p class="mt-2">เหมาะสำหรับสถานการณ์ที่เรารู้ระยะทางเป้าหมาย แต่ไม่รู้ว่าใช้เวลาเท่าไหร่</p>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-2 mt-2 text-sm">
                            <b>ลองทำดู:</b> ใส่ค่าที่คาดเดาในช่อง "ทายความเร็วปลาย" แล้วกด Play เพื่อดูว่าแอนิเมชันวิ่งไปถึงระยะ s ด้วยความเร็ว v เท่าไหร่!
                        </div>
                    `;
                    break;
                case 4:
                    html = `
                        <div class="text-center mb-3"><span class="bg-blue-100 text-blue-800 font-bold text-lg px-3 py-1 rounded">s = ( (u + v) / 2 ) · t</span></div>
                        <p>สมการนี้มองระยะทางในมุมของ <b>ความเร็วเฉลี่ย</b></p>
                        <ul class="list-disc pl-5 space-y-2 mt-2">
                            <li>เส้นประสีม่วง คือระดับความเร็วเฉลี่ย กึ่งกลางระหว่าง u และ v</li>
                            <li>ถ้ารถวิ่งด้วยความเร็วเฉลี่ยนี้คงที่ จะได้พื้นที่ <span class="text-purple-600 font-bold">สี่เหลี่ยมผืนผ้า</span> ซึ่งมีขนาดเท่ากับพื้นที่ใต้กราฟเป๊ะ!</li>
                            <li>ดังนั้น ระยะทาง = ความเร็วเฉลี่ย × เวลา</li>
                        </ul>
                    `;
                    break;
                case 5:
                    html = `
                        <div class="text-center mb-3"><span class="bg-blue-100 text-blue-800 font-bold text-lg px-3 py-1 rounded">s = vt - ½at²</span></div>
                        <p>สมการนี้มองย้อนกลับ! แทนที่จะเริ่มจาก u</p>
                        <ul class="list-disc pl-5 space-y-2 mt-2">
                            <li>สมมติว่ารถวิ่งด้วยความเร็วสูงสุด <b>v</b> มาตั้งแต่ต้น จะได้ <span class="text-yellow-600 font-bold">พื้นที่สี่เหลี่ยมใหญ่สุด (vt)</span></li>
                            <li>แต่ความเป็นจริงตอนต้นรถวิ่งช้ากว่า v เราจึงต้อง <b>ลบพื้นที่ส่วนเกินออก</b></li>
                            <li>ส่วนที่ลบออกคือ <span class="text-red-500 font-bold">พื้นที่สามเหลี่ยมด้านบน (½at²)</span> ที่แรเงาสีแดง</li>
                        </ul>
                    `;
                    break;
            }
            explText.innerHTML = html;
        }

        // --- Animation Logic ---
        function togglePlay() {
            if (state.isPlaying) {
                pauseAnimation();
            } else {
                startAnimation();
            }
        }

        function startAnimation() {
            if(state.t_curr >= getTargetTime()) {
                resetAnimation(); // Auto reset if at end
            }
            
            if (state.mode === 3 && vGuessInput.value === "") {
                vGuessInput.classList.add('ring-2', 'ring-red-500');
                setTimeout(()=>vGuessInput.classList.remove('ring-2', 'ring-red-500'), 1000);
                return; // Require guess
            }

            state.isPlaying = true;
            btnPlay.innerHTML = '<i class="fa-solid fa-pause text-xl"></i>';
            btnPlay.classList.replace('bg-blue-600', 'bg-red-500');
            btnPlay.classList.replace('hover:bg-blue-700', 'hover:bg-red-600');
            state.lastFrameTime = performance.now();
            
            // Re-calculate physics to ensure values are fresh, especially for mode 3
            calculatePhysics(); 
            
            cancelAnimationFrame(state.animReq);
            state.animReq = requestAnimationFrame(animationLoop);
        }

        function pauseAnimation() {
            state.isPlaying = false;
            btnPlay.innerHTML = '<i class="fa-solid fa-play text-xl ml-1"></i>';
            btnPlay.classList.replace('bg-red-500', 'bg-blue-600');
            btnPlay.classList.replace('hover:bg-red-600', 'hover:bg-blue-700');
            cancelAnimationFrame(state.animReq);
        }

        function resetAnimation() {
            pauseAnimation();
            state.t_curr = 0;
            
            if(state.mode === 3) m3Result.classList.add('hidden');
            
            updateUI(0, getU(), 0); // t=0, v=u, s=0
            drawAnimationState();
            drawGraphs();
        }

        function getU() { return state.mode === 3 ? state.m3_u : state.u; }
        function getA() { return state.mode === 3 ? state.m3_a : state.a; }
        function getTargetTime() { return state.t; } // state.t is computed in mode 3

        function animationLoop(timestamp) {
            if (!state.isPlaying) return;

            const dt = (timestamp - state.lastFrameTime) / 1000; // in seconds
            state.lastFrameTime = timestamp;

            // Speed up animation slightly for better feel, real-time might be too slow for large t
            const animSpeed = 1.0; 
            state.t_curr += dt * animSpeed;

            const targetT = getTargetTime();
            
            if (state.t_curr >= targetT) {
                state.t_curr = targetT;
                pauseAnimation();
                handleAnimationEnd();
            }

            // Current state calculations
            const u = getU();
            const a = getA();
            const currentV = u + a * state.t_curr;
            const currentS = (u * state.t_curr) + (0.5 * a * state.t_curr * state.t_curr);

            updateUI(state.t_curr, currentV, currentS);
            drawAnimationState();
            drawGraphs();

            if (state.isPlaying) {
                state.animReq = requestAnimationFrame(animationLoop);
            }
        }

        function updateUI(t, v, s) {
            timeDisplay.textContent = `t = ${t.toFixed(2)} s`;
            velDisplay.textContent = `v = ${v.toFixed(2)} m/s`;
            distDisplay.textContent = `s = ${s.toFixed(2)} m`;
        }

        function handleAnimationEnd() {
            if (state.mode === 3) {
                const guess = parseFloat(vGuessInput.value);
                const actual = state.v;
                m3Result.classList.remove('hidden');
                
                if(isNaN(guess)) return;

                const diff = Math.abs(guess - actual);
                if (diff < 0.5) {
                    m3Result.className = "mt-2 text-sm font-bold text-green-600 p-2 bg-green-50 rounded border border-green-200";
                    m3Result.innerHTML = `<i class="fa-solid fa-face-smile-beam mr-1"></i> เก่งมาก! ความเร็วปลายจริงคือ ${actual.toFixed(2)} m/s (คำนวณจาก √(${getU()}² + 2(${getA()})(${state.m3_sTarget})))`;
                } else {
                    m3Result.className = "mt-2 text-sm font-bold text-blue-600 p-2 bg-blue-50 rounded border border-blue-200";
                    m3Result.innerHTML = `<i class="fa-solid fa-circle-info mr-1"></i> ความเร็วปลายจริงคือ <b>${actual.toFixed(2)} m/s</b><br><span class="text-xs font-normal">คำนวณจาก: v = √(u² + 2as) = √(${getU()}² + 2(${getA()})(${state.m3_sTarget}))</span>`;
                }
                calcV.textContent = actual.toFixed(2) + " m/s";
            }
        }

        // --- Drawing Functions ---
        function resizeCanvases() {
            const vtContainer = vtCanvas.parentElement;
            vtCanvas.width = vtContainer.clientWidth;
            vtCanvas.height = vtContainer.clientHeight;
            
            const stContainer = stCanvas.parentElement;
            stCanvas.width = stContainer.clientWidth;
            stCanvas.height = stContainer.clientHeight;
            
            drawGraphs();
        }

        function drawAnimationState() {
            const containerWidth = animContainer.clientWidth;
            
            // Calculate max scale based on max possible distance in current setup
            let maxDist = 0;
            if (state.mode === 3) {
                maxDist = state.m3_sTarget * 1.2; // 20% margin
            } else {
                // To prevent jumping scale, base max dist on max slider values
                const maxU = 40; const maxA = 10; const maxT = 10;
                maxDist = (maxU * state.t) + (0.5 * maxA * state.t * state.t);
                maxDist = Math.max(maxDist, 50); // Minimum scale
            }

            // Margin: left 5%, right 5%
            const startPx = containerWidth * 0.05;
            const endPx = containerWidth * 0.95;
            const availablePx = endPx - startPx;
            
            const pxPerMeter = availablePx / maxDist;

            // Current values
            const u = getU();
            const a = getA();
            const currentS = (u * state.t_curr) + (0.5 * a * state.t_curr * state.t_curr);
            const currentV = u + a * state.t_curr;

            // Move Object
            const objX = startPx + (currentS * pxPerMeter);
            objectDiv.style.left = `${objX}px`;

            // Draw Velocity Vector
            velVector.style.left = `${objX}px`;
            // Scale vector length visually (e.g., 2px per m/s)
            let vecLen = currentV * 2; 
            // Handle negative velocity visually if needed (though limits mostly keep it positive)
            if (vecLen < 0) {
                velVector.style.transform = 'rotate(180deg)';
                velVector.style.width = `${Math.abs(vecLen)}px`;
            } else {
                velVector.style.transform = 'none';
                velVector.style.width = `${vecLen}px`;
            }
        }

        function drawGraphs() {
            drawVT();
            drawST();
        }

        function drawVT() {
            const ctx = vtCtx;
            const w = vtCanvas.width;
            const h = vtCanvas.height;
            ctx.clearRect(0, 0, w, h);

            // Margins
            const pad = 30;
            const gw = w - pad * 2;
            const gh = h - pad * 2;
            const originX = pad;
            const originY = h - pad;

            const u = getU();
            const a = getA();
            const targetT = getTargetTime();
            
            // Determine max values for scaling
            const finalV = u + a * targetT;
            let maxV = Math.max(u, finalV, 10); // at least 10 scale
            if (state.mode === 5) maxV = Math.max(maxV, finalV); // Mode 5 highlights maxV heavily
            
            const maxX = targetT * 1.1 || 5; // 10% margin
            const maxY = maxV * 1.2;

            const scaleX = gw / maxX;
            const scaleY = gh / maxY;

            // Helper to map coordinates
            const mx = (t) => originX + t * scaleX;
            const my = (v) => originY - v * scaleY;

            // Draw Axes
            ctx.beginPath();
            ctx.strokeStyle = '#94a3b8'; // slate-400
            ctx.lineWidth = 2;
            ctx.moveTo(originX, pad/2); ctx.lineTo(originX, originY); ctx.lineTo(w - pad/2, originY);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#64748b'; ctx.font = '12px Sarabun'; ctx.textAlign = 'right';
            ctx.fillText('v (m/s)', originX - 5, pad);
            ctx.textAlign = 'center';
            ctx.fillText('t (s)', w - pad/2, originY + 20);

            // --- MODE SPECIFIC HIGHLIGHTS ---
            ctx.save();
            
            if (state.mode === 1) { // v = u + at
                // Draw Dashed 'u' line
                ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.strokeStyle = '#cbd5e1';
                ctx.moveTo(mx(0), my(u)); ctx.lineTo(mx(targetT), my(u)); ctx.stroke();
                ctx.setLineDash([]);
                
                // Draw 'at' arrow
                drawArrow(ctx, mx(targetT), my(u), mx(targetT), my(finalV), '#8b5cf6', 2); // purple
                
                // Text labels
                ctx.fillStyle = '#2563eb'; ctx.font = 'bold 14px Sarabun'; ctx.textAlign = 'right';
                ctx.fillText('u', originX - 5, my(u) + 5);
                ctx.fillStyle = '#8b5cf6'; ctx.textAlign = 'left';
                ctx.fillText('at', mx(targetT) + 10, my(u + (finalV-u)/2));
                
                // Slope triangle
                if(a !== 0) {
                    ctx.beginPath(); ctx.strokeStyle = '#f59e0b'; ctx.lineWidth = 1;
                    ctx.moveTo(mx(targetT*0.5), my(u + a*targetT*0.5));
                    ctx.lineTo(mx(targetT*0.8), my(u + a*targetT*0.5));
                    ctx.lineTo(mx(targetT*0.8), my(u + a*targetT*0.8));
                    ctx.stroke();
                    ctx.fillStyle = '#f59e0b';
                    ctx.fillText('a (ความชัน)', mx(targetT*0.8) + 5, my(u + a*targetT*0.65));
                }
            } 
            else if (state.mode === 2) { // s = ut + 1/2at^2
                // Rectangle ut (Blue)
                ctx.fillStyle = 'rgba(59, 130, 246, 0.2)';
                ctx.fillRect(mx(0), my(u), mx(targetT) - originX, originY - my(u));
                ctx.fillStyle = '#2563eb'; ctx.textAlign = 'center';
                if(u > 0) ctx.fillText('ut', mx(targetT/2), my(u/2));

                // Triangle 1/2at^2 (Green)
                ctx.beginPath();
                ctx.moveTo(mx(0), my(u));
                ctx.lineTo(mx(targetT), my(u));
                ctx.lineTo(mx(targetT), my(finalV));
                ctx.fillStyle = 'rgba(34, 197, 94, 0.2)';
                ctx.fill();
                ctx.fillStyle = '#16a34a';
                if(Math.abs(finalV-u) > 0.5) ctx.fillText('½at²', mx(targetT*0.66), my(u + (finalV-u)/3));
            }
            else if (state.mode === 4) { // s = (u+v)/2 * t
                const avgV = (u + finalV) / 2;
                
                // Average V Rectangle (Purple)
                ctx.fillStyle = 'rgba(168, 85, 247, 0.2)';
                ctx.fillRect(mx(0), my(avgV), mx(targetT) - originX, originY - my(avgV));
                
                // Average V line
                ctx.beginPath(); ctx.setLineDash([5, 5]); ctx.strokeStyle = '#a855f7'; ctx.lineWidth = 2;
                ctx.moveTo(mx(0), my(avgV)); ctx.lineTo(mx(targetT), my(avgV)); ctx.stroke();
                
                ctx.fillStyle = '#9333ea'; ctx.textAlign = 'center';
                ctx.fillText('vเฉลี่ย × t', mx(targetT/2), my(avgV/2));
                ctx.textAlign = 'right'; ctx.fillText('avg v', originX-5, my(avgV)+5);
            }
            else if (state.mode === 5) { // s = vt - 1/2at^2
                // Full Rectangle vt (Yellow)
                ctx.fillStyle = 'rgba(234, 179, 8, 0.2)';
                ctx.fillRect(mx(0), my(finalV), mx(targetT) - originX, originY - my(finalV));
                ctx.fillStyle = '#ca8a04'; ctx.textAlign = 'center';
                ctx.fillText('vt (พื้นที่ทั้งหมด)', mx(targetT/2), my(finalV/2));

                // Subtracted Triangle (Red Hatch pattern simulation via transparency for simplicity in pure canvas, or draw lines)
                ctx.beginPath();
                ctx.moveTo(mx(0), my(finalV));
                ctx.lineTo(mx(0), my(u));
                ctx.lineTo(mx(targetT), my(finalV));
                
                // Draw hatch manually
                ctx.save();
                ctx.clip();
                ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)'; // red
                ctx.lineWidth = 2;
                for(let i = -w; i < w*2; i+=10) {
                    ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i+h, h); ctx.stroke();
                }
                ctx.restore();
                
                ctx.beginPath(); ctx.strokeStyle = '#ef4444'; ctx.lineWidth=2; ctx.setLineDash([4,4]);
                ctx.moveTo(mx(0), my(finalV)); ctx.lineTo(mx(0), my(u)); ctx.lineTo(mx(targetT), my(finalV)); ctx.closePath(); ctx.stroke();
                
                ctx.fillStyle = '#dc2626'; ctx.textAlign = 'left';
                ctx.fillText('หักออก ½at²', mx(targetT*0.1), my(u + (finalV-u)*0.8));
            }
            else { // Mode 0 or 3 - Normal Area
                 ctx.beginPath();
                 ctx.moveTo(mx(0), originY);
                 ctx.lineTo(mx(0), my(u));
                 ctx.lineTo(mx(targetT), my(finalV));
                 ctx.lineTo(mx(targetT), originY);
                 ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                 ctx.fill();
            }

            ctx.restore();

            // --- Draw Actual Motion Graph Line ---
            ctx.beginPath();
            ctx.strokeStyle = '#2563eb'; // blue-600
            ctx.lineWidth = 3;
            ctx.moveTo(mx(0), my(u));
            ctx.lineTo(mx(targetT), my(finalV));
            ctx.stroke();

            // --- Draw Current Time Indicator ---
            if (state.t_curr > 0) {
                const currV = u + a * state.t_curr;
                // Dot
                ctx.beginPath();
                ctx.arc(mx(state.t_curr), my(currV), 5, 0, Math.PI * 2);
                ctx.fillStyle = '#ef4444'; // red-500
                ctx.fill();
                // Vertical Line
                ctx.beginPath(); ctx.setLineDash([3, 3]); ctx.strokeStyle = 'rgba(239, 68, 68, 0.5)';
                ctx.moveTo(mx(state.t_curr), originY); ctx.lineTo(mx(state.t_curr), my(currV));
                ctx.stroke(); ctx.setLineDash([]);
            }
        }

        function drawST() {
            const ctx = stCtx;
            const w = stCanvas.width;
            const h = stCanvas.height;
            ctx.clearRect(0, 0, w, h);

            // Margins
            const pad = 30;
            const gw = w - pad * 2;
            const gh = h - pad * 2;
            const originX = pad;
            const originY = h - pad;

            const u = getU();
            const a = getA();
            const targetT = getTargetTime();
            
            // Calc max S
            const finalS = (u * targetT) + (0.5 * a * targetT * targetT);
            const maxS = Math.max(finalS, 10);
            const maxX = targetT * 1.1 || 5;

            const scaleX = gw / maxX;
            const scaleY = gh / (maxS * 1.2);

            const mx = (t) => originX + t * scaleX;
            const my = (s) => originY - s * scaleY;

            // Draw Axes
            ctx.beginPath(); ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 2;
            ctx.moveTo(originX, pad/2); ctx.lineTo(originX, originY); ctx.lineTo(w - pad/2, originY);
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#64748b'; ctx.font = '12px Sarabun'; ctx.textAlign = 'right';
            ctx.fillText('s (m)', originX - 5, pad);
            ctx.textAlign = 'center';
            ctx.fillText('t (s)', w - pad/2, originY + 20);

            // Draw Curve
            ctx.beginPath();
            ctx.strokeStyle = '#16a34a'; // green-600
            ctx.lineWidth = 3;
            ctx.moveTo(mx(0), my(0));
            // Draw parabola segments
            const steps = 50;
            for(let i=1; i<=steps; i++) {
                const tt = (targetT * i) / steps;
                const ss = (u * tt) + (0.5 * a * tt * tt);
                ctx.lineTo(mx(tt), my(ss));
            }
            ctx.stroke();

            // --- Draw Current Time Indicator ---
            if (state.t_curr > 0) {
                const currS = (u * state.t_curr) + (0.5 * a * state.t_curr * state.t_curr);
                ctx.beginPath();
                ctx.arc(mx(state.t_curr), my(currS), 5, 0, Math.PI * 2);
                ctx.fillStyle = '#ef4444';
                ctx.fill();
            }
        }

        // Helper to draw arrow
        function drawArrow(ctx, fromx, fromy, tox, toy, color, width){
            const headlen = 10;
            const angle = Math.atan2(toy-fromy,tox-fromx);
            ctx.beginPath(); ctx.strokeStyle = color; ctx.lineWidth = width;
            ctx.moveTo(fromx, fromy); ctx.lineTo(tox, toy);
            ctx.lineTo(tox-headlen*Math.cos(angle-Math.PI/6), toy-headlen*Math.sin(angle-Math.PI/6));
            ctx.moveTo(tox, toy);
            ctx.lineTo(tox-headlen*Math.cos(angle+Math.PI/6), toy-headlen*Math.sin(angle+Math.PI/6));
            ctx.stroke();
        }

        // --- Comparison Modal Logic ---
        function openCompareModal() {
            // Ensure physics is up to date based on general inputs (not mode 3 specific inputs if we are there, let's use standard u,a,t for proof)
            const u = state.u;
            const a = state.a;
            const t = state.t;
            
            const v = u + a*t;
            const s = (u*t) + (0.5*a*t*t);

            document.getElementById('cmpU').textContent = u;
            document.getElementById('cmpA').textContent = a;
            document.getElementById('cmpT').textContent = t;

            const tbody = document.getElementById('compareTableBody');
            tbody.innerHTML = `
                <tr>
                    <td class="p-3 font-medium text-blue-700">1. v = u + at</td>
                    <td class="p-3 font-mono text-sm">v = ${u} + (${a})(${t})</td>
                    <td class="p-3 text-right font-bold">v = ${v.toFixed(2)} m/s</td>
                </tr>
                <tr class="bg-slate-50">
                    <td class="p-3 font-medium text-blue-700">2. s = ut + ½at²</td>
                    <td class="p-3 font-mono text-sm">s = (${u})(${t}) + 0.5(${a})(${t})²</td>
                    <td class="p-3 text-right font-bold">s = ${s.toFixed(2)} m</td>
                </tr>
                <tr>
                    <td class="p-3 font-medium text-blue-700">3. v² = u² + 2as</td>
                    <td class="p-3 font-mono text-sm">v = √(${u}² + 2(${a})(${s.toFixed(2)}))</td>
                    <td class="p-3 text-right font-bold">v = ${Math.sqrt(u*u + 2*a*s).toFixed(2)} m/s</td>
                </tr>
                <tr class="bg-slate-50">
                    <td class="p-3 font-medium text-blue-700">4. s = ½(u + v)t</td>
                    <td class="p-3 font-mono text-sm">s = 0.5(${u} + ${v.toFixed(2)})(${t})</td>
                    <td class="p-3 text-right font-bold">s = ${(0.5 * (u + v) * t).toFixed(2)} m</td>
                </tr>
                <tr>
                    <td class="p-3 font-medium text-blue-700">5. s = vt - ½at²</td>
                    <td class="p-3 font-mono text-sm">s = (${v.toFixed(2)})(${t}) - 0.5(${a})(${t})²</td>
                    <td class="p-3 text-right font-bold">s = ${(v*t - 0.5*a*t*t).toFixed(2)} m</td>
                </tr>
            `;

            compareModal.classList.add('flex');
        }

        // --- Master Update ---
        function updateAll() {
            calculatePhysics();
            drawGraphs();
            drawAnimationState();
        }

        // --- Initialization ---
        function init() {
            setupListeners();
            calculatePhysics();
            updateExplanation();
            
            // Small delay to allow container layout to finish before getting dimensions
            setTimeout(() => {
                resizeCanvases();
                updateAll();
            }, 100);
        }

        window.onload = init;

    </script>
</body>
</html>
